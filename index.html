<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCMP | Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; letter-spacing: -0.02em; background-color: #fcfcfc; }
        .ikea-blue { background-color: #0058AB; }
        .ikea-yellow { background-color: #FFCC00; }
        .btn-animate { transition: all 0.2s ease; }
        .btn-animate:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://mgkhhsiwnndsy rrakdho.supabase.co'.replace(/\s/g, ''); 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1na2hoc2l3bm5kc3lycmFrZGhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1ODkwMDksImV4cCI6MjA4NjE2NTAwOX0.gIeRH6Ckck-K59-zUi7G3KeB0hoCR0bjpQ5h4W9Ec6Y';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const ADMIN_EMAIL = 'henrik.h.wiik@gmail.com';
        const TEAM = ['Ikke tildelt', 'Henrik', 'Marthe', 'Karolina'];

        const App = () => {
            const [user, setUser] = useState(null);
            const [isRegistering, setIsRegistering] = useState(false);
            const [view, setView] = useState('dashboard');
            const [requests, setRequests] = useState([]);
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState({ text: '', type: '' });

            useEffect(() => {
                supabaseClient.auth.getSession().then(({ data: { session } }) => setUser(session?.user ?? null));
                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => setUser(session?.user ?? null));
                fetchData();
                return () => subscription.unsubscribe();
            }, []);

            const fetchData = async () => {
                const { data } = await supabaseClient.from('requests').select('*').order('created_at', { ascending: false });
                setRequests(data || []);
            };

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                const email = e.target.email.value;
                const password = e.target.password.value;

                if (isRegistering) {
                    const { error } = await supabaseClient.auth.signUp({ email, password });
                    if (error) {
                        alert("Feil ved registrering: " + error.message);
                    } else {
                        alert("Bruker opprettet! Sjekk e-posten din for bekreftelse (hvis aktivert i Supabase).");
                        setIsRegistering(false);
                    }
                } else {
                    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) alert("Feil: " + error.message);
                }
                setLoading(false);
            };

            const handleLogout = async () => { await supabaseClient.auth.signOut(); window.location.reload(); };

            const handleSubmitRequest = async (e) => {
                e.preventDefault();
                setLoading(true);
                const fd = new FormData(e.target);
                const { error } = await supabaseClient.from('requests').insert([{
                    title: fd.get('title'),
                    description: fd.get('description'),
                    type: view === 'new' ? 'Dashboard' : 'Error',
                    requested_by: user.email,
                    status: 'Ny',
                    assigned_to: 'Ikke tildelt'
                }]);
                if (!error) {
                    setMsg({ text: 'Saken er sendt til Henrik!', type: 'success' });
                    e.target.reset();
                    fetchData();
                    setTimeout(() => { setMsg({ text: '', type: '' }); setView('dashboard'); }, 2000);
                }
                setLoading(false);
            };

            const updateField = async (id, field, val) => {
                await supabaseClient.from('requests').update({ [field]: val }).eq('id', id);
                fetchData();
            };

            if (!user) return (
                <div className="h-screen flex items-center justify-center bg-[#0058AB] p-6">
                    <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md">
                        <div className="text-center mb-10">
                            <div className="w-16 h-16 ikea-yellow rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg">
                                <span className="text-[#0058AB] font-black text-2xl">IK</span>
                            </div>
                            <h1 className="text-3xl font-black tracking-tighter uppercase">{isRegistering ? 'Opprett bruker' : 'Velkommen'}</h1>
                            <p className="text-gray-400 text-[10px] font-bold tracking-widest mt-1">RCMP EXPERIENCE DESIGN</p>
                        </div>

                        <form onSubmit={handleAuth} className="space-y-4">
                            <div>
                                <label className="block text-[10px] font-black text-gray-400 uppercase mb-2 ml-1">E-post</label>
                                <input name="email" type="email" placeholder="navn@ikea.com" className="w-full p-4 bg-gray-50 rounded-xl outline-none focus:ring-2 focus:ring-[#0058AB] font-medium" required />
                            </div>
                            <div>
                                <label className="block text-[10px] font-black text-gray-400 uppercase mb-2 ml-1">Passord</label>
                                <input name="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" className="w-full p-4 bg-gray-50 rounded-xl outline-none focus:ring-2 focus:ring-[#0058AB] font-medium" required />
                            </div>
                            <button disabled={loading} className="w-full ikea-blue text-white py-4 rounded-xl font-black uppercase tracking-widest text-xs btn-animate shadow-lg">
                                {loading ? 'Vent...' : (isRegistering ? 'Registrer meg' : 'Logg inn')}
                            </button>
                        </form>

                        <div className="mt-8 text-center">
                            <button onClick={() => setIsRegistering(!isRegistering)} className="text-xs font-bold text-gray-400 hover:text-[#0058AB] transition-colors">
                                {isRegistering ? 'Har du allerede bruker? Logg inn' : 'Ny her? Lag en konto'}
                            </button>
                        </div>
                    </div>
                </div>
            );

            const isAdmin = user.email === ADMIN_EMAIL || user.email.includes('@ingka.ikea.com');

            return (
                <div className="flex min-h-screen">
                    {msg.text && <div className="fixed top-10 right-10 bg-black text-white px-8 py-4 rounded-2xl shadow-2xl z-[100] font-bold animate-bounce text-sm">‚ú® {msg.text}</div>}

                    <aside className="w-64 bg-white border-r border-gray-100 flex flex-col fixed h-full shadow-sm">
                        <div className="p-8 mb-4">
                            <div className="flex items-center gap-2 mb-1">
                                <div className="w-6 h-6 ikea-blue rounded-sm"></div>
                                <span className="font-black text-xl tracking-tighter">RCMP</span>
                            </div>
                            <p className="text-[9px] font-black text-gray-300 uppercase tracking-widest">Norway</p>
                        </div>
                        <nav className="flex-1 space-y-1">
                            <button onClick={() => setView('dashboard')} className={`w-full flex items-center gap-4 px-8 py-4 text-sm font-bold ${view === 'dashboard' ? 'bg-gray-50 text-[#0058AB] border-r-4 border-[#0058AB]' : 'text-gray-400'}`}>üìä Oversikt</button>
                            <button onClick={() => setView('new')} className={`w-full flex items-center gap-4 px-8 py-4 text-sm font-bold ${view === 'new' ? 'bg-gray-50 text-[#0058AB] border-r-4 border-[#0058AB]' : 'text-gray-400'}`}>‚ú® Bestill Dashboard</button>
                            <button onClick={() => setView('error')} className={`w-full flex items-center gap-4 px-8 py-4 text-sm font-bold ${view === 'error' ? 'bg-gray-50 text-[#0058AB] border-r-4 border-[#0058AB]' : 'text-gray-400'}`}>‚ö†Ô∏è Rapporter Feil</button>
                            {isAdmin && <button onClick={() => setView('admin')} className={`w-full flex items-center gap-4 px-8 py-4 text-sm font-bold mt-10 ${view === 'admin' ? 'bg-yellow-50 text-yellow-700 border-r-4 border-yellow-400' : 'text-gray-400'}`}>üõ°Ô∏è Admin Panel</button>}
                        </nav>
                        <div className="p-8 border-t border-gray-50">
                            <p className="text-[10px] font-bold text-gray-400 truncate mb-2">{user.email}</p>
                            <button onClick={handleLogout} className="text-[10px] font-black text-red-500 uppercase tracking-widest hover:underline">Logg ut</button>
                        </div>
                    </aside>

                    <main className="flex-1 ml-64 p-16">
                        <h2 className="text-4xl font-black tracking-tight text-gray-900 mb-12">
                            {view === 'admin' ? 'Admin Kontroll' : view === 'dashboard' ? 'Dine Saker' : 'Opprett Sak'}
                        </h2>

                        {view === 'dashboard' && (
                            <div className="grid gap-4">
                                {requests.filter(r => r.requested_by === user.email).length === 0 ? (
                                    <div className="bg-white p-20 rounded-[2rem] text-center border-2 border-dashed border-gray-100 text-gray-300 font-bold uppercase text-xs tracking-widest">Ingen aktive saker</div>
                                ) : (
                                    requests.filter(r => r.requested_by === user.email).map(req => (
                                        <div key={req.id} className="bg-white p-6 rounded-2xl border border-gray-50 shadow-sm flex justify-between items-center hover:shadow-md transition-all">
                                            <div>
                                                <p className="text-[9px] font-black text-blue-500 uppercase mb-1">{req.type}</p>
                                                <h3 className="font-bold text-gray-900">{req.title}</h3>
                                                <p className="text-xs text-gray-400 mt-1">Ansvarlig: <span className="text-gray-700 font-bold">{req.assigned_to}</span></p>
                                            </div>
                                            <span className={`text-[10px] font-black uppercase px-3 py-1 rounded-full ${req.status === 'Fullf√∏rt' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-800'}`}>{req.status}</span>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {view === 'admin' && (
                            <div className="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden">
                                <table className="w-full text-left">
                                    <thead className="bg-gray-50 text-[10px] font-black text-gray-400 uppercase tracking-widest">
                                        <tr><th className="p-6">Sak</th><th className="p-6">Status</th><th className="p-6">Ansvarlig</th></tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-50">
                                        {requests.map(req => (
                                            <tr key={req.id} className="hover:bg-gray-50/50">
                                                <td className="p-6">
                                                    <p className="font-bold text-gray-900">{req.title}</p>
                                                    <p className="text-[10px] text-gray-400">{req.requested_by}</p>
                                                </td>
                                                <td className="p-6">
                                                    <select value={req.status} onChange={(e) => updateField(req.id, 'status', e.target.value)} className="bg-white border border-gray-100 rounded-lg text-[10px] font-black p-2 outline-none">
                                                        <option>Ny</option><option>I arbeid</option><option>Venter</option><option>Fullf√∏rt</option>
                                                    </select>
                                                </td>
                                                <td className="p-6">
                                                    <select value={req.assigned_to} onChange={(e) => updateField(req.id, 'assigned_to', e.target.value)} className="bg-blue-50 text-blue-600 border-0 rounded-lg text-[10px] font-black p-2 outline-none">
                                                        {TEAM.map(t => <option key={t}>{t}</option>)}
                                                    </select>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {(view === 'new' || view === 'error') && (
                            <form onSubmit={handleSubmitRequest} className="bg-white p-12 rounded-[2.5rem] shadow-sm border border-gray-100 max-w-xl">
                                <div className="space-y-6 text-left">
                                    <div>
                                        <label className="block text-[10px] font-black text-gray-400 uppercase mb-3 ml-1 tracking-widest">Tittel</label>
                                        <input name="title" placeholder="Hva trenger du?" className="w-full p-5 bg-gray-50 rounded-xl outline-none focus:ring-2 focus:ring-[#0058AB] font-bold" required />
                                    </div>
                                    <div>
                                        <label className="block text-[10px] font-black text-gray-400 uppercase mb-3 ml-1 tracking-widest">Beskrivelse</label>
                                        <textarea name="description" placeholder="Utdyp her..." className="w-full p-5 bg-gray-50 rounded-xl h-40 outline-none focus:ring-2 focus:ring-[#0058AB]" required></textarea>
                                    </div>
                                    <button disabled={loading} className="w-full ikea-blue text-white py-5 rounded-xl font-black uppercase tracking-widest text-xs btn-animate shadow-xl shadow-blue-900/10">Send foresp√∏rsel ‚ûú</button>
                                </div>
                            </form>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
